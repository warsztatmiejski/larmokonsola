<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LARMO! konsola – Warsztat Miejski</title>
    <!-- Custom Font -->
    <style>
        @font-face {
            font-family: "Data 70";
            src: url("fonts/Data70.woff2") format("woff2");
        }
        :root {
            --key-color: rgb(245, 25, 0);
        }
        body {
            font-family: "Data 70", sans-serif;
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background: #000000;
            color: white;
            display: flex;
            flex-direction: column;
        }
        #beatmaker-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }
        #controls {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #222;
            box-sizing: border-box;
        }
        #logo {
            font-size: 2em;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--key-color);
        }
        #logo span {
            font-size: 0.8em;
            color: #fff;
        }
        #global-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #global-controls .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            background: #444;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            min-width: 60px;
        }
        #play-pause-icon,
        #clear-icon,
        #load-icon {
            width: 16px;
            height: 16px;
            background-size: contain;
            background-repeat: no-repeat;
            display: inline-block;
        }
        #play-pause-icon.play {
            background-image: url('icons/play.svg');
        }
        #play-pause-icon.pause {
            background-image: url('icons/pause.svg');
        }
        #clear-icon {
            background-image: url('icons/clear.svg');
        }
        #load-icon {
            background-image: url('icons/load.svg');
        }
        #play-pause.active {
            background: #666;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            background: #444;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            min-width: 80px;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #333;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 1;
            top: 100%;
            left: 0;
        }
        .dropdown-content a {
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            text-transform: uppercase;
            display: block;
            font-size: 1.2em;
        }
        .dropdown-content a:hover {
            background-color: #555;
        }
        .dropdown:hover .dropdown-content {
            display: block;
        }
        .tempo-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="range"] {
            -webkit-appearance: none;
            background: transparent;
            margin: 0;
            padding: 0;
        }
        input[type="range"].bpm-slider {
            width: 150px;
        }
        input[type="range"].bpm-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            margin-top: 0px;
            background: #555;
        }
        input[type="range"].bpm-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 32px;
            height: 32px;
            background: var(--key-color) url('icons/tempo.svg') center no-repeat;
            background-size: 24px 24px;
            cursor: pointer;
            margin-top: -14px;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 2px;
            background: #fff;
            border: none;
            border-radius: 0;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background-color: var(--key-color);
            background-position: center;
            background-repeat: no-repeat;
            background-size: 16px 16px;
            cursor: pointer;
            margin-top: -10px;
        }
        input[type="range"]:focus {
            outline: none;
        }
        input[type="range"]:focus::-webkit-slider-runnable-track {
            background: #ccc;
        }
        .volume-slider::-webkit-slider-thumb {
            background-image: url('icons/volume.svg');
            transform: rotate(90deg);
            transform-origin: center;
        }
        .rate-slider::-webkit-slider-thumb {
            background-image: url('icons/rate.svg');
            transform: rotate(90deg);
            transform-origin: center;
        }
        #bpm-value {
            font-size: 1.5em;
            margin-left: 8px;
            line-height: 32px;
        }
        #beatmaker {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .track {
            display: flex;
            align-items: stretch;
            gap: 2px;
            margin-top: 8px;
            flex: 1;
        }
        .control-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
            padding: 8px;
            background-color: var(--beat-color);
            background-color: #444;
        }
        .control-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            mix-blend-mode: normal;
            filter: saturate(50%);
            opacity: 0.25;
        }
        .control-wrapper .track-name {
            font-size: 1.5em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .control-wrapper .track-name,
        .control-wrapper .form-label,
        .control-wrapper .form-range {
            position: relative;
            z-index: 1;
            color: white;
        }
        .control-wrapper .sliders-container {
            flex: 1;
            position: relative;
            min-width: 80px;
        }
        .slider-wrapper {
            position: absolute;
            width: 50%;
            height: 100%;
        }
        .slider-wrapper.volume-slider-wrapper {
            left: 0;
        }
        .slider-wrapper.rate-slider-wrapper {
            right: 0;
        }
        .slider-wrapper input[type="range"] {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) rotate(270deg);
            transform-origin: center;
            width: 100%;
            margin: 0;
        }
        .beat-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
            width: 100%;
            height: 100%;
        }
        .beat {
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background-color: #222;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .beat.active {
            background-color: var(--beat-color);
            box-shadow: 0 0 30px rgba(0,0,0,0.75) inset;
        }
        .beat .beat-image {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0;
            mix-blend-mode: overlay;
        }
        .beat.active .beat-image {
            opacity: 1;
        }
        .beat.highlight {
            background-color: rgba(255, 255, 255, 0.35);
            box-shadow: 0 0 30px rgba(0,0,0,0.85) inset;
        }
        .beat.highlight.active {
            background-color: rgba(255, 255, 255, 0.95);
        }
        .beat-grid .beat:nth-child(4n+1) {
            border-left: 1px solid #444;
        }
        .beat-grid .beat:nth-child(4n+4) {
            border-right: 1px solid #444;
        }
        #footer {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            background: #222;
            color: #fff;
            padding: 8px 16px;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        #footer p {
            display: inline-block;
            margin: 0;
        }
        #footer #wm-logo {
            width: 150px;
            height: 40px;
            background-size: contain;
            background-repeat: no-repeat;
            display: inline-block;
            background-image: url('icons/wm-logo.svg');
        }
        @media (max-width: 768px) {
            #global-controls {
                flex-direction: column;
            }
            .control-wrapper {
                min-width: 60px;
            }
            .sliders-container {
                width: 40px;
                min-width: 40px;
            }
            .beat-grid {
                grid-template-columns: repeat(16, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="beatmaker-container">
        <div id="controls">
            <div id="logo">Larmo! <span>konsola</span></div>
            <div id="global-controls">
                <button id="play-pause" class="btn">
                    <span id="play-pause-icon" class="play"></span>
                </button>
                <!-- Clear All Button (now also stops the music) -->
                <button id="clear-all" class="btn">
                    <span id="clear-icon"></span>
                </button>
                <!-- Dropdown Menu for Patterns with Icon -->
                <div class="dropdown">
                    <button class="dropdown-button btn">
                        <span id="load-icon"></span>
                    </button>
                    <div class="dropdown-content" id="pattern-list">
                        <!-- Pattern items will be inserted here -->
                    </div>
                </div>
                <div class="tempo-control">
                    <input type="range" id="tempo-slider" class="form-range bpm-slider" min="60" max="180" value="100">
                    <span id="bpm-value">100 BPM</span>
                </div>
            </div>
        </div>
        <div id="beatmaker"></div>
        <!-- Footer -->
        <div id="footer">
            <div id="wm-logo"></div>
            <p>Więcej dźwięków na naszym stanowisku na antresoli<span id="schodki"></span></p>
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
        const AudioModule = (() => {
            const audioFolder = 'audio/';
            const imageFolder = 'images/';
            const soundLibrary = [
                { name: 'Masz.1', audio: 'maszyna.wav', image: 'maszyna.jpg' },
                { name: 'Fabr.1', audio: 'fabryka.wav', image: 'fabryka.jpg' },
                { name: 'Cyk', audio: 'hihat.wav', image: 'cyk.jpg' },
                { name: 'Bang', audio: 'bang.wav', image: 'bang.jpg' }
            ];
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let soundBuffers = [];
            async function loadSounds() {
                for (let sound of soundLibrary) {
                    try {
                        const response = await fetch(audioFolder + sound.audio);
                        const arrayBuffer = await response.arrayBuffer();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        soundBuffers.push(audioBuffer);
                    } catch (error) {
                        console.error(`Failed to load sound: ${sound.audio}`, error);
                    }
                }
            }
            return {
                audioContext,
                soundLibrary,
                soundBuffers,
                loadSounds,
                imageFolder
            };
        })();

        const BeatmakerModule = (() => {
            const { audioContext, soundLibrary, soundBuffers, loadSounds, imageFolder } = AudioModule;
            const numTracks = soundLibrary.length;
            const numBeats = 16;
            let beatGrid = Array.from({ length: numTracks }, () => Array(numBeats).fill(false));
            let currentBeat = 0;
            let isPlaying = false;
            let tempo = 100;
            let scheduledTime = 0;
            let lookahead = 25.0;
            let scheduleAheadTime = 0.1;
            let timerID;
            const playbackRates = Array(numTracks).fill(1.0);
            const volumes = Array(numTracks).fill(1.0);
            const beatmakerDiv = document.getElementById('beatmaker');
            const playPauseButton = document.getElementById('play-pause');
            const tempoSlider = document.getElementById('tempo-slider');
            const bpmValue = document.getElementById('bpm-value');
            const clearAllButton = document.getElementById('clear-all');
            const patternListDiv = document.getElementById('pattern-list');

            const predefinedPatterns = [
                {
                    name: 'Hip-Hop Huta',
                    tempo: 90,
                    data: [
                        { track: 0, volume: 0.8, rate: 1.0, beats: '1000100010001000' },
                        { track: 1, volume: 0.7, rate: 1.0, beats: '0010001000100010' },
                        { track: 2, volume: 1.0, rate: 1.0, beats: '0101010101010101' },
                        { track: 3, volume: 0.9, rate: 1.0, beats: '1010101010101010' }
                    ]
                },
                {
                    name: 'Fa-Bryka',
                    tempo: 120,
                    data: [
                        { track: 0, volume: 1.0, rate: 1.0, beats: '1100110011001100' },
                        { track: 1, volume: 0.8, rate: 1.2, beats: '0011001100110011' },
                        { track: 2, volume: 0.6, rate: 0.8, beats: '1001100110011001' },
                        { track: 3, volume: 1.0, rate: 1.0, beats: '0110011001100110' }
                    ]
                }
                // Add more patterns as needed
            ];

            const gainNodes = Array(numTracks).fill(null).map(() => audioContext.createGain());
            const trackColors = Array(numTracks).fill(null).map(() => getRandomColor());

            function init() {
                createTrackControls();
                loadSounds().then(() => {
                    updateUI();
                    setupEventListeners();
                    updateSliderWidths();
                    populatePatternList();
                });
            }

            function createTrackControls() {
                for (let i = 0; i < numTracks; i++) {
                    const trackDiv = document.createElement('div');
                    trackDiv.classList.add('track');
                    const controlWrapper = document.createElement('div');
                    controlWrapper.classList.add('control-wrapper');
                    const beatColor = trackColors[i];
                    controlWrapper.style.setProperty('--beat-color', beatColor);
                    const controlBgDiv = document.createElement('div');
                    controlBgDiv.classList.add('control-bg');
                    controlBgDiv.style.backgroundImage = `url(${imageFolder}${soundLibrary[i].image})`;
                    controlWrapper.appendChild(controlBgDiv);
                    const trackName = document.createElement('div');
                    trackName.classList.add('track-name');
                    trackName.textContent = soundLibrary[i].name;
                    controlWrapper.appendChild(trackName);
                    const slidersContainer = document.createElement('div');
                    slidersContainer.classList.add('sliders-container');
                    const volumeWrapper = document.createElement('div');
                    volumeWrapper.classList.add('slider-wrapper', 'volume-slider-wrapper');
                    const volumeInput = document.createElement('input');
                    volumeInput.type = 'range';
                    volumeInput.classList.add('form-range', 'volume-slider');
                    volumeInput.min = '0';
                    volumeInput.max = '1';
                    volumeInput.step = '0.01';
                    volumeInput.value = '1.0';
                    volumeInput.dataset.trackIndex = i;
                    volumeInput.addEventListener('input', (e) => {
                        const trackIdx = parseInt(e.target.dataset.trackIndex);
                        volumes[trackIdx] = parseFloat(e.target.value);
                        gainNodes[trackIdx].gain.value = volumes[trackIdx];
                    });
                    volumeWrapper.appendChild(volumeInput);
                    const rateWrapper = document.createElement('div');
                    rateWrapper.classList.add('slider-wrapper', 'rate-slider-wrapper');
                    const playbackRateInput = document.createElement('input');
                    playbackRateInput.type = 'range';
                    playbackRateInput.classList.add('form-range', 'rate-slider');
                    playbackRateInput.min = '0.5';
                    playbackRateInput.max = '2.0';
                    playbackRateInput.step = '0.01';
                    playbackRateInput.value = '1.0';
                    playbackRateInput.dataset.trackIndex = i;
                    playbackRateInput.addEventListener('input', (e) => {
                        const trackIdx = parseInt(e.target.dataset.trackIndex);
                        playbackRates[trackIdx] = parseFloat(e.target.value);
                    });
                    rateWrapper.appendChild(playbackRateInput);
                    slidersContainer.appendChild(volumeWrapper);
                    slidersContainer.appendChild(rateWrapper);
                    controlWrapper.appendChild(slidersContainer);
                    trackDiv.appendChild(controlWrapper);
                    const beatGridDiv = document.createElement('div');
                    beatGridDiv.classList.add('beat-grid');
                    for (let beat = 0; beat < numBeats; beat++) {
                        const beatDiv = document.createElement('div');
                        beatDiv.classList.add('beat');
                        beatDiv.dataset.track = i;
                        beatDiv.dataset.beat = beat;
                        const beatImageDiv = document.createElement('div');
                        beatImageDiv.classList.add('beat-image');
                        beatImageDiv.style.backgroundImage = `url(${imageFolder}${soundLibrary[i].image})`;
                        beatDiv.appendChild(beatImageDiv);
                        beatDiv.style.setProperty('--beat-color', beatColor);
                        beatDiv.addEventListener('click', () => {
                            beatGrid[i][beat] = !beatGrid[i][beat];
                            beatDiv.classList.toggle('active', beatGrid[i][beat]);
                        });
                        beatGridDiv.appendChild(beatDiv);
                    }
                    trackDiv.appendChild(beatGridDiv);
                    beatmakerDiv.appendChild(trackDiv);
                }
            }

            function populatePatternList() {
                predefinedPatterns.forEach((pattern, index) => {
                    const patternItem = document.createElement('a');
                    patternItem.href = '#';
                    patternItem.textContent = pattern.name;
                    patternItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        loadPattern(index);
                    });
                    patternListDiv.appendChild(patternItem);
                });
            }

            function loadPattern(index) {
                const pattern = predefinedPatterns[index];
                if (pattern) {
                    clearAllTracks();
                    tempo = pattern.tempo || 100;
                    tempoSlider.value = tempo;
                    bpmValue.textContent = `${tempo} BPM`;
                    pattern.data.forEach(item => {
                        const trackIdx = item.track;
                        volumes[trackIdx] = item.volume;
                        gainNodes[trackIdx].gain.value = item.volume;
                        playbackRates[trackIdx] = item.rate;
                        const volumeSlider = document.querySelector(`.volume-slider[data-track-index='${trackIdx}']`);
                        if (volumeSlider) {
                            volumeSlider.value = item.volume;
                        }
                        const rateSlider = document.querySelector(`.rate-slider[data-track-index='${trackIdx}']`);
                        if (rateSlider) {
                            rateSlider.value = item.rate;
                        }
                        const beats = item.beats.split('').map(char => char === '1');
                        beatGrid[trackIdx] = beats;
                    });
                    updateBeatGridUI();
                }
            }

            function updateBeatGridUI() {
                for (let track = 0; track < numTracks; track++) {
                    for (let beat = 0; beat < numBeats; beat++) {
                        const beatDiv = document.querySelector(`.beat[data-track='${track}'][data-beat='${beat}']`);
                        if (beatDiv) {
                            beatDiv.classList.toggle('active', beatGrid[track][beat]);
                        }
                    }
                }
            }

            function clearAllTracks() {
                beatGrid = Array.from({ length: numTracks }, () => Array(numBeats).fill(false));
                updateBeatGridUI();
                volumes.fill(1.0);
                playbackRates.fill(1.0);
                document.querySelectorAll('.volume-slider').forEach(slider => slider.value = 1.0);
                document.querySelectorAll('.rate-slider').forEach(slider => slider.value = 1.0);
                gainNodes.forEach(node => node.gain.value = 1.0);
                tempo = 100;
                tempoSlider.value = tempo;
                bpmValue.textContent = `${tempo} BPM`;
                stopPlayback();
            }

            function setupEventListeners() {
                playPauseButton.addEventListener('click', togglePlayPause);
                clearAllButton.addEventListener('click', clearAllTracks);
                tempoSlider.addEventListener('input', (e) => {
                    tempo = e.target.value;
                    bpmValue.textContent = `${tempo} BPM`;
                });
                const beatDivs = document.querySelectorAll('.beat');
                beatDivs.forEach(beatDiv => {
                    beatDiv.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const track = parseInt(beatDiv.dataset.track);
                        const beat = parseInt(beatDiv.dataset.beat);
                        beatGrid[track][beat] = !beatGrid[track][beat];
                        beatDiv.classList.toggle('active', beatGrid[track][beat]);
                    });
                });
                window.addEventListener('resize', updateSliderWidths);
            }

            function updateSliderWidths() {
                const sliderWrappers = document.querySelectorAll('.slider-wrapper');
                sliderWrappers.forEach(wrapper => {
                    const slider = wrapper.querySelector('input[type="range"]');
                    const wrapperHeight = wrapper.clientHeight;
                    slider.style.width = `${wrapperHeight}px`;
                });
            }

            function playSound(buffer, time, trackIndex) {
                if (buffer) {
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.playbackRate.value = playbackRates[trackIndex];
                    source.connect(gainNodes[trackIndex]).connect(audioContext.destination);
                    source.start(time);
                }
            }

            function scheduler() {
                while (scheduledTime < audioContext.currentTime + scheduleAheadTime) {
                    scheduleBeat(currentBeat, scheduledTime);
                    scheduledTime += (60 / tempo) / 4;
                    currentBeat = (currentBeat + 1) % numBeats;
                }
            }

            function scheduleBeat(beatNumber, time) {
                for (let track = 0; track < numTracks; track++) {
                    if (beatGrid[track][beatNumber]) {
                        playSound(soundBuffers[track], time, track);
                    }
                }
                highlightBeat(beatNumber);
            }

            function highlightBeat(beatNumber) {
                const highlightedBeats = document.querySelectorAll('.beat.highlight');
                highlightedBeats.forEach(beatDiv => {
                    beatDiv.classList.remove('highlight');
                });
                for (let track = 0; track < numTracks; track++) {
                    const beatDiv = document.querySelector(`.beat[data-track='${track}'][data-beat='${beatNumber}']`);
                    if (beatDiv) {
                        beatDiv.classList.add('highlight');
                    }
                }
            }

            function getRandomColor() {
                const hue = Math.floor(Math.random() * 360);
                const saturation = Math.floor(Math.random() * (100 - 70 + 1)) + 70;
                const lightness = Math.floor(Math.random() * (40 - 20 + 1)) + 20;
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            function togglePlayPause() {
                const playPauseIcon = document.getElementById('play-pause-icon');
                if (isPlaying) {
                    clearInterval(timerID);
                    isPlaying = false;
                    playPauseIcon.classList.remove('pause');
                    playPauseIcon.classList.add('play');
                    playPauseButton.classList.remove('active');
                } else {
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    scheduledTime = audioContext.currentTime;
                    timerID = setInterval(scheduler, lookahead);
                    isPlaying = true;
                    playPauseIcon.classList.remove('play');
                    playPauseIcon.classList.add('pause');
                    playPauseButton.classList.add('active');
                }
            }

            function stopPlayback() {
                const playPauseIcon = document.getElementById('play-pause-icon');
                if (isPlaying) {
                    clearInterval(timerID);
                    isPlaying = false;
                    playPauseIcon.classList.remove('pause');
                    playPauseIcon.classList.add('play');
                    playPauseButton.classList.remove('active');
                }
                currentBeat = 0;
                scheduledTime = audioContext.currentTime;
                const highlightedBeats = document.querySelectorAll('.beat.highlight');
                highlightedBeats.forEach(beatDiv => {
                    beatDiv.classList.remove('highlight');
                });
            }

            function updateUI() {
                bpmValue.textContent = `${tempo} BPM`;
            }

            document.body.addEventListener('click', () => {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
            }, { once: true });

            return {
                init
            };
        })();

        BeatmakerModule.init();
    </script>
</body>
</html>