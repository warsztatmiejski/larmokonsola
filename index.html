<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags and Title -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Larmokonsola â€“ Warsztat Miejski</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <style>
        /* General Styles */
        body {
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background: #000000;
            color: white;
            display: flex;
            flex-direction: column;
        }

        /* Beatmaker Container */
        #beatmaker-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        /* Controls */
        #controls {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #222;
            box-sizing: border-box;
        }

        #logo {
            font-size: 1.5em;
            margin: 0;
        }

        #global-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #global-controls .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: #444;
            border: none;
            color: white;
            cursor: pointer;
        }

        #tempo-slider {
            width: 150px;
        }

        /* Beatmaker Grid */
        #beatmaker {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-y: auto;
            box-sizing: border-box;
        }

        /* Track */
        .track {
            display: flex;
            align-items: stretch;
            gap: 2px;
            margin-top: 8px; /* 8px gap between tracks */
            flex: 1; /* Make tracks fill available height */
        }

        /* Controls Wrapper */
        .control-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 80px;
            padding: 8px;
            background-color: var(--beat-color);
        }

        /* Control Background */
        .control-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            mix-blend-mode: overlay; /* Use overlay blend mode */
        }

        /* Ensure controls are displayed normally */
        .control-wrapper .track-name,
        .control-wrapper .form-label,
        .control-wrapper .form-range {
            position: relative;
            z-index: 1;
            color: white;
        }

        /* Beat Grid */
        .beat-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
            width: 100%;
            height: 100%;
        }

        /* Beat */
        .beat {
            width: 100%;
            height: 100%;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background-color: #222;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Selected Beat Background Color */
        .beat.active {
            background-color: var(--beat-color); /* Use CSS variable for color */
        }

        .beat .beat-image {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0;
            mix-blend-mode: overlay; /* Use overlay blend mode */
        }

        .beat.active .beat-image {
            opacity: 1;
        }

        .beat.highlight {
            background-color: rgba(255, 255, 255, 0.35);
        }

        .beat.highlight.active {
            background-color: rgba(255, 255, 255, 0.95);
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            #global-controls {
                flex-direction: column;
            }

            .control-wrapper {
                min-width: 60px;
            }

            .beat-grid {
                grid-template-columns: repeat(16, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="beatmaker-container">
        <div id="controls">
            <div id="logo">Larmokonsola</div>
            <div id="global-controls">
                <button id="play-pause" class="btn btn-primary"><i class="bi bi-play-fill"></i></button>
                <button id="stop" class="btn btn-secondary"><i class="bi bi-stop-fill"></i></button>
                <div class="d-flex align-items-center">
                    <label for="tempo-slider" class="form-label me-2"><i class="bi bi-speedometer2"></i></label>
                    <input type="range" id="tempo-slider" class="form-range" min="60" max="180" value="100">
                    <span id="bpm-value" class="ms-2">100 BPM</span>
                </div>
            </div>
        </div>
        <div id="beatmaker"></div>
    </div>

    <!-- JavaScript Code -->
    <script>
        // Audio and Sound Management Module
        const AudioModule = (() => {
            const audioFolder = 'audio/';
            const imageFolder = 'images/';
            const soundLibrary = [
                { name: 'Kick', audio: 'kick.wav', image: 'kick.png' },
                { name: 'Snare', audio: 'snare.wav', image: 'snare.png' },
                { name: 'Hi-Hat', audio: 'hihat.wav', image: 'hihat.png' },
                { name: 'Tom', audio: 'tom.wav', image: 'tom.png' }
                // Add more sounds as needed
            ];

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let soundBuffers = [];

            // Load audio files into buffers
            async function loadSounds() {
                for (let sound of soundLibrary) {
                    try {
                        const response = await fetch(audioFolder + sound.audio);
                        const arrayBuffer = await response.arrayBuffer();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        soundBuffers.push(audioBuffer);
                        console.log(`Loaded sound: ${sound.audio}`);
                    } catch (error) {
                        console.error(`Failed to load sound: ${sound.audio}`, error);
                    }
                }
            }

            return {
                audioContext,
                soundLibrary,
                soundBuffers,
                loadSounds,
                imageFolder
            };
        })();

        // Beatmaker Module
        const BeatmakerModule = (() => {
            const { audioContext, soundLibrary, soundBuffers, loadSounds, imageFolder } = AudioModule;

            const numTracks = soundLibrary.length;
            const numBeats = 16;
            let beatGrid = Array.from({ length: numTracks }, () => Array(numBeats).fill(false));
            let currentBeat = 0;
            let isPlaying = false;
            let tempo = 100;
            let scheduledTime = 0;
            let lookahead = 25.0; // How frequently to call scheduling function (in milliseconds)
            let scheduleAheadTime = 0.1; // How far ahead to schedule audio (in seconds)
            let timerID;

            const playbackRates = Array(numTracks).fill(1.0);
            const volumes = Array(numTracks).fill(1.0);

            const beatmakerDiv = document.getElementById('beatmaker');
            const playPauseButton = document.getElementById('play-pause');
            const stopButton = document.getElementById('stop');
            const tempoSlider = document.getElementById('tempo-slider');
            const bpmValue = document.getElementById('bpm-value');

            // Create Gain Nodes for volume control
            const gainNodes = Array(numTracks).fill(null).map(() => audioContext.createGain());

            // Assign random colors to each track
            const trackColors = Array(numTracks).fill(null).map(() => getRandomColor());

            // Initialize UI
            function init() {
                createTrackControls();
                loadSounds().then(() => {
                    updateUI();
                    setupEventListeners();
                });
            }

            // Create Track Controls
            function createTrackControls() {
                for (let i = 0; i < numTracks; i++) {
                    const trackDiv = document.createElement('div');
                    trackDiv.classList.add('track');

                    const controlWrapper = document.createElement('div');
                    controlWrapper.classList.add('control-wrapper');

                    // Use trackColors[i] directly
                    const beatColor = trackColors[i];

                    // Set CSS variable for beat color
                    controlWrapper.style.setProperty('--beat-color', beatColor);

                    // Create control background div
                    const controlBgDiv = document.createElement('div');
                    controlBgDiv.classList.add('control-bg');
                    controlBgDiv.style.backgroundImage = `url(${imageFolder}${soundLibrary[i].image})`;

                    controlWrapper.appendChild(controlBgDiv);

                    // Track Name
                    const trackName = document.createElement('div');
                    trackName.classList.add('track-name');
                    trackName.textContent = soundLibrary[i].name;
                    controlWrapper.appendChild(trackName);

                    // Volume Slider
                    const volumeLabel = document.createElement('label');
                    volumeLabel.classList.add('form-label');
                    volumeLabel.innerHTML = '<i class="bi bi-volume-up"></i>';

                    const volumeInput = document.createElement('input');
                    volumeInput.type = 'range';
                    volumeInput.classList.add('form-range');
                    volumeInput.min = '0';
                    volumeInput.max = '1';
                    volumeInput.step = '0.01';
                    volumeInput.value = '1.0';
                    volumeInput.addEventListener('input', (e) => {
                        volumes[i] = parseFloat(e.target.value);
                        gainNodes[i].gain.value = volumes[i];
                    });

                    // Playback Rate Slider
                    const rateLabel = document.createElement('label');
                    rateLabel.classList.add('form-label');
                    rateLabel.innerHTML = '<i class="bi bi-speedometer2"></i>';

                    const playbackRateInput = document.createElement('input');
                    playbackRateInput.type = 'range';
                    playbackRateInput.classList.add('form-range');
                    playbackRateInput.min = '0.5';
                    playbackRateInput.max = '2.0';
                    playbackRateInput.step = '0.01';
                    playbackRateInput.value = '1.0';
                    playbackRateInput.addEventListener('input', (e) => {
                        playbackRates[i] = parseFloat(e.target.value);
                    });

                    controlWrapper.appendChild(volumeLabel);
                    controlWrapper.appendChild(volumeInput);
                    controlWrapper.appendChild(rateLabel);
                    controlWrapper.appendChild(playbackRateInput);

                    trackDiv.appendChild(controlWrapper);

                    const beatGridDiv = document.createElement('div');
                    beatGridDiv.classList.add('beat-grid');

                    for (let beat = 0; beat < numBeats; beat++) {
                        const beatDiv = document.createElement('div');
                        beatDiv.classList.add('beat');
                        beatDiv.dataset.track = i;
                        beatDiv.dataset.beat = beat;

                        // Create beatImageDiv inside beatDiv
                        const beatImageDiv = document.createElement('div');
                        beatImageDiv.classList.add('beat-image');
                        beatImageDiv.style.backgroundImage = `url(${imageFolder}${soundLibrary[i].image})`;

                        beatDiv.appendChild(beatImageDiv);

                        // Set CSS variable for beat color when selected
                        beatDiv.style.setProperty('--beat-color', beatColor);

                        beatDiv.addEventListener('click', () => {
                            beatGrid[i][beat] = !beatGrid[i][beat];
                            beatDiv.classList.toggle('active', beatGrid[i][beat]);
                        });
                        beatGridDiv.appendChild(beatDiv);
                    }
                    trackDiv.appendChild(beatGridDiv);
                    beatmakerDiv.appendChild(trackDiv);
                }
            }

            // Event Listeners
            function setupEventListeners() {
                playPauseButton.addEventListener('click', togglePlayPause);
                stopButton.addEventListener('click', stopPlayback);

                tempoSlider.addEventListener('input', (e) => {
                    tempo = e.target.value;
                    bpmValue.textContent = `${tempo} BPM`;
                });

                // Touch support for mobile devices
                const beatDivs = document.querySelectorAll('.beat');
                beatDivs.forEach(beatDiv => {
                    beatDiv.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const track = parseInt(beatDiv.dataset.track);
                        const beat = parseInt(beatDiv.dataset.beat);
                        beatGrid[track][beat] = !beatGrid[track][beat];
                        beatDiv.classList.toggle('active', beatGrid[track][beat]);
                    });
                });
            }

            // Play Sound
            function playSound(buffer, time, trackIndex) {
                if (buffer) {
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.playbackRate.value = playbackRates[trackIndex];
                    source.connect(gainNodes[trackIndex]).connect(audioContext.destination);
                    source.start(time);
                }
            }

            // Scheduler
            function scheduler() {
                while (scheduledTime < audioContext.currentTime + scheduleAheadTime) {
                    scheduleBeat(currentBeat, scheduledTime);
                    scheduledTime += (60 / tempo) / 4;
                    currentBeat = (currentBeat + 1) % numBeats;
                }
            }

            // Schedule a Beat
            function scheduleBeat(beatNumber, time) {
                for (let track = 0; track < numTracks; track++) {
                    if (beatGrid[track][beatNumber]) {
                        playSound(soundBuffers[track], time, track);
                    }
                }
                highlightBeat(beatNumber);
            }

            // Highlight Beat
            function highlightBeat(beatNumber) {
                // Remove 'highlight' class from all beats
                const highlightedBeats = document.querySelectorAll('.beat.highlight');
                highlightedBeats.forEach(beatDiv => {
                    beatDiv.classList.remove('highlight');
                });

                // Add 'highlight' class to current beats
                for (let track = 0; track < numTracks; track++) {
                    const beatDiv = document.querySelector(`.beat[data-track='${track}'][data-beat='${beatNumber}']`);
                    if (beatDiv) {
                        beatDiv.classList.add('highlight');
                    }
                }
            }

            // Generate Random Color with Controlled Saturation and Lightness
            function getRandomColor() {
                // Generate a random hue between 0 and 360 degrees
                const hue = Math.floor(Math.random() * 360);
                // Set saturation between 70% and 100% for vivid colors
                const saturation = Math.floor(Math.random() * (100 - 70 + 1)) + 70; // 70% to 100%
                // Set lightness between 20% and 40% to avoid too dark or too light colors
                const lightness = Math.floor(Math.random() * (40 - 20 + 1)) + 20; // 20% to 40%

                // Return the HSL color string
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            // Toggle Play/Pause
            function togglePlayPause() {
                if (isPlaying) {
                    clearInterval(timerID);
                    isPlaying = false;
                    playPauseButton.innerHTML = '<i class="bi bi-play-fill"></i>';
                    playPauseButton.classList.remove('btn-danger');
                    playPauseButton.classList.add('btn-primary');
                    // Do not remove highlight to keep it on current beat
                } else {
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    scheduledTime = audioContext.currentTime;
                    timerID = setInterval(scheduler, lookahead);
                    isPlaying = true;
                    playPauseButton.innerHTML = '<i class="bi bi-pause-fill"></i>';
                    playPauseButton.classList.remove('btn-primary');
                    playPauseButton.classList.add('btn-danger');
                }
            }

            // Stop Playback
            function stopPlayback() {
                if (isPlaying) {
                    clearInterval(timerID);
                    isPlaying = false;
                    playPauseButton.innerHTML = '<i class="bi bi-play-fill"></i>';
                    playPauseButton.classList.remove('btn-danger');
                    playPauseButton.classList.add('btn-primary');
                }
                currentBeat = 0;
                scheduledTime = audioContext.currentTime;
                // Remove highlight from all beats
                const highlightedBeats = document.querySelectorAll('.beat.highlight');
                highlightedBeats.forEach(beatDiv => {
                    beatDiv.classList.remove('highlight');
                });
            }

            // Update UI
            function updateUI() {
                bpmValue.textContent = `${tempo} BPM`;
            }

            return {
                init
            };
        })();

        // Initialize the Beatmaker
        BeatmakerModule.init();
    </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>